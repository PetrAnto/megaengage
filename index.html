<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MegaEngage â€” Testnet dApp + Airdrop Calculator</title>
  <meta name="description" content="MegaETH testnet dApp (network, tx, contract) + MEGA airdrop calculator + tweet badge.">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.min.js"></script>
  <style>
    :root {
      --bg:#0b0d10; --card:#13161a; --border:#2a2f36; --fg:#e6e8eb; --muted:#97a1ad; --accent:#0d6efd;
    }
    body{ background:var(--bg); color:var(--fg); }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; }
    .muted{ color:var(--muted); }
    a{ color:#6ab0ff; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .nav-tabs .nav-link{ border:0; color:var(--muted); }
    .nav-tabs .nav-link.active{ color:var(--fg); background:transparent; border-bottom:2px solid var(--accent); }
    .btn{ border-radius:12px; }
    .table{ color:var(--fg); }
    .table thead th{ border-bottom-color:var(--border); }
    .table td, .table th{ border-color:var(--border); }
    .form-control, .form-select{ background:#0f1216; border:1px solid var(--border); color:var(--fg); }
    .form-control::placeholder{ color:#73808f; }
    .divider{ height:1px; background:var(--border); margin:1rem 0; }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
    @media (max-width: 992px){ .grid-2{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
<div class="container py-4">
  <header class="mb-4">
    <h1 class="h3 mb-1">MegaEngage</h1>
    <div class="muted">Testnet dApp (engagement) + MEGA airdrop calculator + tweet badge</div>
  </header>

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-3" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="tab-engage" data-bs-toggle="tab" data-bs-target="#pane-engage" type="button" role="tab">Engage dApp</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-calc" data-bs-toggle="tab" data-bs-target="#pane-calc" type="button" role="tab">Airdrop Calculator</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-tweet" data-bs-toggle="tab" data-bs-target="#pane-tweet" type="button" role="tab">Tweet Badge</button>
    </li>
  </ul>

  <div id="alerts"></div>

  <div class="tab-content">
    <!-- ===================== ENGAGE ===================== -->
    <div class="tab-pane fade show active" id="pane-engage" role="tabpanel" aria-labelledby="tab-engage">
      <div class="row g-3">
        <!-- Wallet / Network -->
        <div class="col-12 col-lg-6">
          <div class="card p-3">
            <h2 class="h5 mb-3">1) Connect & Add MegaETH Testnet</h2>
            <p class="muted mb-2">Chain ID <code>6342</code> Â· RPC <code>https://carrot.megaeth.com/rpc</code> Â· Explorer <code>megaexplorer.xyz</code></p>
            <div class="d-flex gap-2 flex-wrap">
              <button id="btnConnect" class="btn btn-primary">Connect Wallet</button>
              <button id="btnAddNet" class="btn btn-outline-light">Add Network</button>
              <button id="btnSwitch" class="btn btn-outline-light">Switch to MegaETH</button>
            </div>
            <div class="mt-3 small">
              <div>Account: <span id="account" class="muted">â€”</span></div>
              <div>Network: <span id="network" class="muted">â€”</span></div>
              <div>Balance: <span id="balance" class="muted">â€”</span></div>
            </div>
            <div class="divider"></div>
            <p class="muted mb-1">Get test ETH (faucet):</p>
            <ul class="mb-0">
              <li><a href="https://testnet.megaeth.com/" target="_blank" rel="noreferrer">Official testnet portal</a></li>
              <li><a href="https://docs.megaeth.com/faucet" target="_blank" rel="noreferrer">Docs: Faucet</a></li>
            </ul>
          </div>
        </div>
        <!-- Test transaction -->
        <div class="col-12 col-lg-6">
          <div class="card p-3">
            <h2 class="h5 mb-3">2) Fire a Test Transaction</h2>
            <p class="muted">Sends a tiny self-transfer on MegaETH Testnet (needs faucet ETH).</p>
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label">Amount (ETH)</label>
                <input id="txAmount" class="form-control" value="0.00001"/>
              </div>
              <div class="col-6">
                <label class="form-label">Max Fee (gwei)</label>
                <input id="maxFee" class="form-control" value="0.1"/>
              </div>
            </div>
            <button id="btnSendTx" class="btn btn-success mt-2">Send Test Tx</button>
            <div class="mt-3 small" id="txStatus" style="min-height:1.5rem;"></div>
          </div>
        </div>
        <!-- Contract interaction -->
        <div class="col-12">
          <div class="card p-3">
            <h2 class="h5 mb-3">3) Interact with your Counter Contract</h2>
            <p class="muted">Deploy once in Remix (see <strong>MegaCounter.sol</strong> below), paste the address, then read/increment.</p>
            <div class="row g-2 align-items-end">
              <div class="col-md-6">
                <label class="form-label">Counter Contract Address</label>
                <input id="ctrAddr" class="form-control" placeholder="0x..."/>
              </div>
              <div class="col-md-6">
                <button id="btnLoadCtr" class="btn btn-outline-light">Load Contract</button>
              </div>
            </div>
            <div class="d-flex gap-2 mt-3 flex-wrap">
              <button id="btnRead" class="btn btn-secondary">Read count()</button>
              <input id="msg" class="form-control" placeholder="message for increment()" style="max-width:280px;">
              <button id="btnInc" class="btn btn-warning">increment(message)</button>
            </div>
            <div class="mt-3 small" id="ctrStatus" style="min-height:1.5rem;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===================== CALCULATOR ===================== -->
    <div class="tab-pane fade" id="pane-calc" role="tabpanel" aria-labelledby="tab-calc">
      <!-- Inputs -->
      <div class="card p-3 mb-3">
        <h2 class="h5 mb-3">MEGA Airdrop / Allocation Calculator</h2>
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Bid amount (USDT)</label>
            <input id="bid" type="number" class="form-control" value="2700" min="0" step="1">
          </div>
          <div class="col-md-3">
            <label class="form-label">Clearing price P ($/MEGA)</label>
            <input id="price" type="number" class="form-control" value="0.0999" min="0.000001" step="0.0001">
            <div class="form-text muted">Auction price; cap = 0.0999</div>
          </div>
          <div class="col-md-3">
            <label class="form-label">Lock discount (%)</label>
            <div class="input-group">
              <input id="discount" type="number" class="form-control" value="10" min="0" max="50" step="1">
              <button id="toggleLock" class="btn btn-outline-light">Toggle lock</button>
            </div>
            <div class="form-text muted">10% if 1-year lock</div>
          </div>
          <div class="col-md-3">
            <label class="form-label">Bonus tokens (%)</label>
            <input id="bonus" type="number" class="form-control" value="0" min="0" max="100" step="1">
            <div class="form-text muted">Leaderboard bonus at TGE</div>
          </div>

          <div class="col-md-3">
            <label class="form-label">Total supply (MEGA)</label>
            <input id="supply" type="number" class="form-control" value="10000000000" step="1000000">
          </div>
          <div class="col-md-3">
            <label class="form-label">TGE FDV (preset)</label>
            <select id="fdvPreset" class="form-select">
              <option value="1000000000">$1.0B</option>
              <option value="1500000000">$1.5B</option>
              <option value="2000000000" selected>$2.0B</option>
              <option value="3000000000">$3.0B</option>
              <option value="5000000000">$5.0B</option>
              <option value="custom">Custom belowâ€¦</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">TGE FDV (custom, $)</label>
            <input id="fdvCustom" type="number" class="form-control" value="2000000000" step="50000000">
          </div>

          <div class="col-md-3">
            <label class="form-label">ATOM staking APY (%)</label>
            <input id="apy" type="number" class="form-control" value="20" min="0" max="100" step="0.1">
            <div class="form-text muted">For 12m breakeven</div>
          </div>
        </div>
      </div>

      <!-- Results -->
      <div class="grid-2 mb-3">
        <div class="card p-3">
          <h3 class="h6 mb-3">Allocation & ROI (at TGE)</h3>
          <div class="row g-2">
            <div class="col-6">
              <div class="muted">Effective paid price</div>
              <div class="h5 mono" id="effPrice">â€”</div>
            </div>
            <div class="col-6">
              <div class="muted">TGE price (= FDV / supply)</div>
              <div class="h5 mono" id="tgePrice">â€”</div>
            </div>
            <div class="col-6">
              <div class="muted">Tokens (no bonus)</div>
              <div class="h5 mono" id="tokensBase">â€”</div>
            </div>
            <div class="col-6">
              <div class="muted">Tokens (with bonus)</div>
              <div class="h5 mono" id="tokensBonus">â€”</div>
            </div>
          </div>
          <hr>
          <div class="row g-2">
            <div class="col-6">
              <div class="muted">Value @ TGE (no bonus)</div>
              <div class="h5 mono" id="valBase">â€”</div>
              <div class="muted">ROI %</div>
              <div class="h6 mono" id="roiBase">â€”</div>
            </div>
            <div class="col-6">
              <div class="muted">Value @ TGE (with bonus)</div>
              <div class="h5 mono" id="valBonus">â€”</div>
              <div class="muted">ROI %</div>
              <div class="h6 mono" id="roiBonus">â€”</div>
            </div>
          </div>
          <div class="mt-3">
            <button id="btnCSV" class="btn btn-outline-light btn-sm">Download CSV</button>
          </div>
        </div>

        <div class="card p-3">
          <h3 class="h6 mb-3">Breakeven vs ATOM Staking (12 months)</h3>
          <div class="row g-2">
            <div class="col-md-4">
              <div class="muted">Compounding</div>
              <select id="compound" class="form-select">
                <option value="12" selected>Monthly</option>
                <option value="4">Quarterly</option>
                <option value="1">Annual</option>
              </select>
            </div>
            <div class="col-md-8">
              <div class="muted">ATOM USD scenarios</div>
              <div class="d-flex gap-2 flex-wrap">
                <button class="btn btn-outline-light btn-sm" data-chg="-0.3">âˆ’30%</button>
                <button class="btn btn-outline-light btn-sm" data-chg="0">0%</button>
                <button class="btn btn-outline-light btn-sm" data-chg="0.5">+50%</button>
              </div>
            </div>
          </div>
          <div class="table-responsive mt-3">
            <table class="table table-sm table-bordered align-middle text-nowrap">
              <thead><tr><th>ATOM 12m change</th><th>End value (staking)</th><th>Breakeven TGE price</th><th>Breakeven FDV</th></tr></thead>
              <tbody id="breakevenRows"></tbody>
            </table>
          </div>
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="useBonusForBreakeven">
            <label class="form-check-label" for="useBonusForBreakeven">Use <span class="mono">tokens (with bonus)</span> for breakeven</label>
          </div>
        </div>
      </div>
    </div>

    <!-- ===================== TWEET ===================== -->
    <div class="tab-pane fade" id="pane-tweet" role="tabpanel" aria-labelledby="tab-tweet">
      <div class="card p-3 mb-3">
        <h2 class="h5 mb-2">Tweet Badge Generator</h2>
        <p class="muted mb-3">Bundle your repo/demo and MegaETH testnet tx hashes into a clean tweet.</p>
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Your repo URL (optional)</label>
            <input id="repoUrl" class="form-control" placeholder="https://github.com/you/megaengage">
          </div>
          <div class="col-md-4">
            <label class="form-label">Live demo URL (optional)</label>
            <input id="siteUrl" class="form-control" placeholder="https://yourname.github.io/megaengage/">
          </div>
          <div class="col-md-4">
            <label class="form-label">Your X handle (optional)</label>
            <input id="xHandle" class="form-control" placeholder="@yourhandle">
          </div>
          <div class="col-12">
            <label class="form-label">Recent MegaETH tx hashes (newline-separated)</label>
            <textarea id="txHashes" class="form-control mono" rows="4" placeholder="0xabc...\n0xdef..."></textarea>
          </div>
          <div class="col-12 d-flex gap-2 flex-wrap">
            <button id="btnBuildTweet" class="btn btn-primary">Build tweet</button>
            <button id="btnCopyTweet" class="btn btn-outline-light">Copy text</button>
            <a id="tweetLink" class="btn btn-success" target="_blank" rel="noreferrer">Open tweet</a>
          </div>
          <div class="col-12">
            <label class="form-label">Tweet preview</label>
            <textarea id="tweetOut" class="form-control mono" rows="7" readonly></textarea>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="pt-3">
    <div class="muted small">
      Tip: commit publicly and post your explorer links + repo demo on X for selection signals.  
      Explorer: <a href="https://megaexplorer.xyz" target="_blank" rel="noreferrer">megaexplorer.xyz</a> â€” Docs: <a href="https://docs.megaeth.com" target="_blank" rel="noreferrer">docs.megaeth.com</a>
    </div>
  </footer>
</div>

<script>
(() => {
  // ---------- Helpers ----------
  const $ = id => document.getElementById(id);
  const alertBox = (msg, type='info') => {
    $('alerts').innerHTML =
      `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
         ${msg}
         <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
       </div>`;
  };
  const fmtUSD = n => isFinite(n) ? n.toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2}) : 'â€”';
  const fmtNum = n => isFinite(n) ? n.toLocaleString(undefined,{maximumFractionDigits:2}) : 'â€”';
  const fmtPrice = n => isFinite(n) ? n.toLocaleString(undefined,{minimumFractionDigits:4, maximumFractionDigits:6}) : 'â€”';
  const clamp = (x, lo, hi) => Math.min(Math.max(x, lo), hi);
  const explorerTx = (hash) => `https://megaexplorer.xyz/tx/${hash}`;

  // ---------- Chain params ----------
  const chainParams = {
    chainId: '0x18C6', // 6342
    chainName: 'MegaETH Testnet',
    nativeCurrency: { name: 'MegaETH Testnet Ether', symbol: 'ETH', decimals: 18 },
    rpcUrls: ['https://carrot.megaeth.com/rpc'],
    blockExplorerUrls: ['https://megaexplorer.xyz']
  };

  // ---------- Wallet / Network ----------
  let provider, signer;

  function requireMM(){
    if (!window.ethereum) { alertBox('MetaMask not detected. Install it to use this dApp.', 'warning'); throw new Error('No MetaMask'); }
  }
  async function refreshBasics(){
    if (!provider || !signer) return;
    const net = await provider.getNetwork();
    $('network').textContent = `${net.name || 'Unknown'} (chainId ${Number(net.chainId)})`;
    const addr = await signer.getAddress();
    $('account').textContent = addr;
    const bal = await provider.getBalance(addr);
    $('balance').textContent = `${ethers.formatEther(bal)} ETH`;
  }

  $('btnConnect').onclick = async () => {
    try {
      requireMM();
      provider = new ethers.BrowserProvider(window.ethereum);
      await provider.send('eth_requestAccounts', []);
      signer = await provider.getSigner();
      alertBox('Wallet connected.', 'success');
      refreshBasics();
    } catch (e) { alertBox('Connect failed: ' + e.message, 'danger'); }
  };
  $('btnAddNet').onclick = async () => {
    try {
      requireMM();
      await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [chainParams] });
      alertBox('MegaETH Testnet added to MetaMask.', 'success');
      refreshBasics();
    } catch (e) { alertBox('Add network failed: ' + e.message, 'danger'); }
  };
  $('btnSwitch').onclick = async () => {
    try {
      requireMM();
      await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: chainParams.chainId }] });
      alertBox('Switched to MegaETH Testnet.', 'success');
      refreshBasics();
    } catch (e) {
      if (e.code === 4902) {
        try {
          await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [chainParams] });
          alertBox('MegaETH Testnet added and switched.', 'success');
          refreshBasics();
        } catch (e2) { alertBox('Switch/add failed: ' + e2.message, 'danger'); }
      } else { alertBox('Switch failed: ' + e.message, 'danger'); }
    }
  };

  // ---------- Test Tx ----------
  $('btnSendTx').onclick = async () => {
    try {
      if (!signer) throw new Error('Connect wallet first.');
      const amt = $('txAmount').value.trim();
      const maxFeeGwei = $('maxFee').value.trim();
      const to = await signer.getAddress(); // self-transfer
      $('txStatus').textContent = 'Sendingâ€¦';
      const tx = await signer.sendTransaction({
        to,
        value: ethers.parseEther(amt),
        maxFeePerGas: ethers.parseUnits(maxFeeGwei, 'gwei'),
        maxPriorityFeePerGas: ethers.parseUnits((Number(maxFeeGwei)/2).toString(), 'gwei')
      });
      $('txStatus').innerHTML = `Submitted: <a href="${explorerTx(tx.hash)}" target="_blank">${tx.hash}</a> â€” waitingâ€¦`;
      const rcpt = await tx.wait();
      $('txStatus').innerHTML = `Confirmed in block ${rcpt.blockNumber}. <a href="${explorerTx(tx.hash)}" target="_blank">View on explorer</a>`;
      refreshBasics();
    } catch (e) { $('txStatus').textContent = 'Error: ' + e.message; }
  };

  // ---------- Contract interaction ----------
  const COUNTER_ABI = [
    { "inputs": [], "name": "count", "outputs":[{"internalType":"uint256","name":"","type":"uint256"}], "stateMutability":"view","type":"function" },
    { "inputs":[{"internalType":"string","name":"message","type":"string"}], "name":"increment", "outputs":[], "stateMutability":"nonpayable", "type":"function" },
    { "anonymous":false,"inputs":[
        {"indexed":true,"internalType":"address","name":"by","type":"address"},
        {"indexed":false,"internalType":"uint256","name":"newCount","type":"uint256"},
        {"indexed":false,"internalType":"string","name":"message","type":"string"}],
      "name":"Increment","type":"event"}
  ];
  let counter;
  $('btnLoadCtr').onclick = async () => {
    try {
      if (!signer) throw new Error('Connect wallet first.');
      const addr = $('ctrAddr').value.trim();
      if (!ethers.isAddress(addr)) throw new Error('Invalid contract address.');
      counter = new ethers.Contract(addr, COUNTER_ABI, signer);
      $('ctrStatus').textContent = 'Loaded. Try Read or Increment.';
    } catch (e) { $('ctrStatus').textContent = 'Error: ' + e.message; }
  };
  $('btnRead').onclick = async () => {
    try {
      if (!counter) throw new Error('Load a contract address first.');
      $('ctrStatus').textContent = 'Readingâ€¦';
      const c = await counter.count();
      $('ctrStatus').textContent = `count() = ${c.toString()}`;
    } catch (e) { $('ctrStatus').textContent = 'Error: ' + e.message; }
  };
  $('btnInc').onclick = async () => {
    try {
      if (!counter) throw new Error('Load a contract address first.');
      const message = $('msg').value || 'hello from MegaEngage';
      $('ctrStatus').textContent = 'Sending increment()â€¦';
      const tx = await counter.increment(message);
      $('ctrStatus').innerHTML = `Submitted: <a href="${explorerTx(tx.hash)}" target="_blank">${tx.hash}</a> â€” waitingâ€¦`;
      const rcpt = await tx.wait();
      $('ctrStatus').innerHTML = `Incremented in block ${rcpt.blockNumber}. <a href="${explorerTx(tx.hash)}" target="_blank">Explorer</a>`;
    } catch (e) { $('ctrStatus').textContent = 'Error: ' + e.message; }
  };

  // ---------- Calculator ----------
  const inputs = ['bid','price','discount','bonus','supply','fdvPreset','fdvCustom','apy','compound'];
  inputs.forEach(id => $(id).addEventListener('input', recalc));
  $('toggleLock').addEventListener('click', () => {
    const d = parseFloat($('discount').value||0);
    $('discount').value = (d>0?0:10).toString();
    recalc();
  });
  $('fdvPreset').addEventListener('change', () => {
    const v = $('fdvPreset').value;
    if (v !== 'custom') $('fdvCustom').value = v;
    recalc();
  });
  document.querySelectorAll('[data-chg]').forEach(btn => btn.addEventListener('click', () => {
    document.querySelectorAll('[data-chg]').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active'); // cosmetic only
  }));
  $('useBonusForBreakeven').addEventListener('change', recalc);

  function vals(){
    const bid = +($('bid').value||0);
    const price = +($('price').value||0);
    const discount = clamp(+($('discount').value||0), 0, 50) / 100;
    const bonus = clamp(+($('bonus').value||0), 0, 100) / 100;
    const supply = +($('supply').value||0);
    const fdv = +($('fdvCustom').value||0);
    const apy = +($('apy').value||0)/100;
    const compound = parseInt($('compound').value||12,10);
    return {bid, price, discount, bonus, supply, fdv, apy, compound};
  }

  function recalc(){
    const v = vals();
    if (!(v.bid>0 && v.price>0 && v.supply>0 && v.fdv>0)) {
      ['effPrice','tokensBase','tokensBonus','tgePrice','valBase','valBonus','roiBase','roiBonus'].forEach(id=>$(id).textContent='â€”');
      $('breakevenRows').innerHTML = '';
      buildTweetPreview(); return;
    }
    const effPrice = v.price * (1 - v.discount);
    const tokensBase = v.bid / effPrice;
    const tokensBonus = tokensBase * (1 + v.bonus);
    const tgePrice = v.fdv / v.supply;
    const valBase = tokensBase * tgePrice;
    const valBonus = tokensBonus * tgePrice;
    const roiBase = (valBase - v.bid) / v.bid * 100;
    const roiBonus = (valBonus - v.bid) / v.bid * 100;

    $('effPrice').textContent = '$' + fmtPrice(effPrice);
    $('tokensBase').textContent = fmtNum(tokensBase);
    $('tokensBonus').textContent = fmtNum(tokensBonus);
    $('tgePrice').textContent = '$' + fmtPrice(tgePrice);
    $('valBase').textContent = fmtUSD(valBase);
    $('valBonus').textContent = fmtUSD(valBonus);
    $('roiBase').textContent = (roiBase>=0?'+':'') + fmtNum(roiBase) + '%';
    $('roiBonus').textContent = (roiBonus>=0?'+':'') + fmtNum(roiBonus) + '%';

    // Breakeven table
    const compound = v.compound;
    const atomScenarios = [-0.30, 0, 0.50];
    const factor = Math.pow(1 + (v.apy/compound), compound);
    const useBonus = $('useBonusForBreakeven').checked;
    const tokensForBreakeven = useBonus ? tokensBonus : tokensBase;
    $('breakevenRows').innerHTML = atomScenarios.map(chg => {
      const endValue = v.bid * factor * (1 + chg);
      const neededPrice = tokensForBreakeven>0 ? endValue / tokensForBreakeven : NaN;
      const neededFDV = neededPrice * v.supply;
      return `<tr>
        <td>${(chg*100>0?'+':'')}${(chg*100).toFixed(0)}%</td>
        <td class="mono">${fmtUSD(endValue)}</td>
        <td class="mono">$${fmtPrice(neededPrice)}</td>
        <td class="mono">${neededFDV>0?('$'+neededFDV.toLocaleString()):'â€”'}</td>
      </tr>`;
    }).join('');

    buildTweetPreview();
  }

  // ---------- CSV Export ----------
  $('btnCSV').addEventListener('click', () => {
    const v = vals();
    if (!(v.bid>0 && v.price>0 && v.supply>0 && v.fdv>0)) { alertBox('Fill bid, price, supply, FDV first.', 'warning'); return; }
    const effPrice = v.price*(1-v.discount);
    const tokensBase = v.bid/effPrice;
    const tokensBonus = tokensBase*(1+v.bonus);
    const tgePrice = v.fdv/v.supply;
    const valBase = tokensBase*tgePrice, valBonus = tokensBonus*tgePrice;
    const roiBase = (valBase-v.bid)/v.bid*100, roiBonus=(valBonus-v.bid)/v.bid*100;

    const factorMonthly = Math.pow(1+(v.apy/12),12);
    const endFlat = v.bid * factorMonthly; // ATOM USD flat scenario (+ staking)

    const rows = [
      ['Parameter','Value'],
      ['Bid (USDT)', v.bid],
      ['Clearing price P', v.price],
      ['Lock discount %', (v.discount*100).toFixed(2)],
      ['Bonus %', (v.bonus*100).toFixed(2)],
      ['Supply', v.supply],
      ['TGE FDV', v.fdv],
      ['TGE price', tgePrice],
      [],
      ['Metric','No bonus','With bonus'],
      ['Effective paid price', effPrice, effPrice],
      ['Tokens', tokensBase, tokensBonus],
      ['Value @ TGE', valBase, valBonus],
      ['ROI %', roiBase, roiBonus],
      [],
      ['Staking APY % (12m, monthly comp.)', (v.apy*100).toFixed(2)],
      ['End value if ATOM/USD flat', endFlat],
      [],
      ['ATOM Î”','End value (staking)','Breakeven TGE px','Breakeven FDV']
    ];

    [-0.30,0,0.50].forEach(chg=>{
      const endValue = v.bid * Math.pow(1+(v.apy/12),12) * (1+chg);
      const neededPrice = (v.bonus>0 ? (v.bid/effPrice)*(1+v.bonus) : (v.bid/effPrice));
      const priceReq = endValue / (v.bonus>0 ? tokensBonus : tokensBase);
      rows.push([
        (chg*100)+'%',
        endValue,
        priceReq,
        priceReq*v.supply
      ]);
    });

    const csv = rows.map(r => (r||[]).map(c => {
      const s = (c===undefined||c===null) ? '' : String(c);
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(',')).join('\n');

    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const ts = new Date().toISOString().replace(/[:.]/g,'-');
    a.download = `mega_calculator_${ts}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  // ---------- Tweet badge ----------
  function buildTweetPreview(){
    const v = vals();
    const effPrice = (v.price>0) ? v.price*(1-v.discount) : NaN;
    const tokens = (v.bid>0 && effPrice>0) ? v.bid/effPrice : 0;
    const tgePrice = (v.fdv>0 && v.supply>0) ? v.fdv/v.supply : 0;
    const roi = (tokens*tgePrice>0 && v.bid>0) ? ((tokens*tgePrice - v.bid)/v.bid*100) : 0;

    const repo = $('repoUrl').value?.trim();
    const site = $('siteUrl').value?.trim();
    const handle = $('xHandle').value?.trim();
    const txs = $('txHashes').value?.trim().split('\n').filter(Boolean) || [];
    const txLine = txs.length ? `Tx: ${txs.slice(0,5).join(' ')}` : '';

    const lines = [
      `ðŸ§ª MegaETH Testnet â€” activity + MEGA calculator`,
      `Bid: $${(v.bid||0).toLocaleString()} â€¢ Lock: ${((v.discount||0)*100).toFixed(0)}% â€¢ Eff: $${isFinite(effPrice)?effPrice.toFixed(5):'â€”'}`,
      `Tokensâ‰ˆ ${isFinite(tokens)?Math.round(tokens).toLocaleString():'â€”'} â€¢ TGE FDV $${(v.fdv||0).toLocaleString()} â€¢ TGE pxâ‰ˆ $${isFinite(tgePrice)?tgePrice.toFixed(3):'â€”'}`,
      `Est. TGE ROIâ‰ˆ ${isFinite(roi)?(roi>=0?'+':'')+roi.toFixed(1)+'%':'â€”'}`,
      repo ? `Repo: ${repo}` : null,
      site ? `Live: ${site}` : null,
      txLine || null,
      handle ? `cc ${handle}` : null,
      `#MegaETH #L2 #web3`
    ].filter(Boolean);

    const text = lines.join('\n');
    $('tweetOut').value = text;
    $('tweetLink').href = 'https://twitter.com/intent/tweet?text=' + encodeURIComponent(text);
  }
  $('btnBuildTweet').addEventListener('click', buildTweetPreview);
  $('btnCopyTweet').addEventListener('click', async ()=>{
    try { await navigator.clipboard.writeText($('tweetOut').value); alertBox('Tweet copied to clipboard!', 'success'); }
    catch(e){ alertBox('Copy failed: ' + e.message, 'danger'); }
  });

  // ---------- React to account/network changes ----------
  if (window.ethereum) {
    window.ethereum.on('accountsChanged', () => location.reload());
    window.ethereum.on('chainChanged', () => location.reload());
  }

  // init
  recalc();
})();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
